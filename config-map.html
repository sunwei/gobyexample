<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>深入理解Hugo: Config Map</title>
    <link rel=stylesheet href="site.css">
  </head>
  <script>
      onkeydown = (e) => {
          
          if (e.key == "ArrowLeft") {
              window.location.href = 'template';
          }
          
          
      }
  </script>
  <body>
    <div class="example" id="config-map">
      <h2><a href="./">深入理解Hugo</a>: Config Map</h2>
      
      <table>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            <a href="https://go.dev/play/p/oqPjHK2x-ZE"><img title="Run code" src="play.png" class="run" /></a><img title="Copy code" src="clipboard.png" class="copy" />
          <pre class="chroma"><span class="kn">package</span> <span class="nx">main</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;bytes&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="nx">toml</span> <span class="s">&#34;github.com/pelletier/go-toml/v2&#34;</span>
    <span class="s">&#34;golang.org/x/tools/txtar&#34;</span>
    <span class="s">&#34;path/filepath&#34;</span>
    <span class="s">&#34;strings&#34;</span>
<span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>文件结构
文件名: config.toml
文件内容：theme = &lsquo;mytheme&rsquo;</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="kd">var</span> <span class="nx">files</span> <span class="p">=</span> <span class="s">&#34;-- config.toml --\n&#34;</span> <span class="o">+</span>
    <span class="s">&#34;theme = &#39;mytheme&#39;&#34;</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Format 文件格式类型</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="kd">type</span> <span class="nx">Format</span> <span class="kt">string</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>TOML 支持的格式，为简单示例，只支持TOML格式</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">TOML</span> <span class="nx">Format</span> <span class="p">=</span> <span class="s">&#34;toml&#34;</span>
<span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>解析上面的文件结构</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">data</span> <span class="o">:=</span> <span class="nx">txtar</span><span class="p">.</span><span class="nf">Parse</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">files</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;File start:&#34;</span><span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Input: 数据，格式，输出类型</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
    <span class="kd">var</span> <span class="nx">configData</span> <span class="p">[]</span><span class="kt">byte</span>
    <span class="kd">var</span> <span class="nx">format</span> <span class="nx">Format</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">any</span><span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>遍历解析生成的所有文件，通过File结构体获取文件名和文件数据
f.Name 获取文件名
f.Data 获取文件数据
如果是config.toml文件，则获取文件数据</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Files</span> <span class="p">{</span>
        <span class="k">if</span> <span class="s">&#34;config.toml&#34;</span> <span class="o">==</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
            <span class="nx">configData</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">TrimSuffix</span><span class="p">(</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">))</span>
            <span class="nx">format</span> <span class="p">=</span> <span class="nf">FormatFromString</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">err</span> <span class="o">:=</span> <span class="nf">UnmarshalTo</span><span class="p">(</span><span class="nx">configData</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
    <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;File end.&#34;</span><span class="p">)</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>FormatFromString turns formatStr, typically a file extension without any &ldquo;.&rdquo;,
into a Format. It returns an empty string for unknown formats.
Hugo 实现</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="kd">func</span> <span class="nf">FormatFromString</span><span class="p">(</span><span class="nx">formatStr</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Format</span> <span class="p">{</span>
    <span class="nx">formatStr</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">formatStr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">formatStr</span><span class="p">,</span> <span class="s">&#34;.&#34;</span><span class="p">)</span> <span class="p">{</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Assume a filename</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
        <span class="nx">formatStr</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span>
            <span class="nx">filepath</span><span class="p">.</span><span class="nf">Ext</span><span class="p">(</span><span class="nx">formatStr</span><span class="p">),</span> <span class="s">&#34;.&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="nx">formatStr</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&#34;toml&#34;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">TOML</span>
    <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>UnmarshalTo unmarshals data in format f into v.</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="kd">func</span> <span class="nf">UnmarshalTo</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">Format</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="k">switch</span> <span class="nx">f</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">TOML</span><span class="p">:</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">toml</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span>
            <span class="s">&#34;unmarshal of format %q is not supported&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span>
    <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code">
            
          <pre class="chroma">    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
      </table>
      
      <table>
        
        <tr>
          <td class="docs">
            <p>解析后得到文件config.toml
准备Input：config file data, format, map[string]any
得到Output: map[theme:mytheme]</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="go">File start:
</span><span class="go">map[theme:mytheme]
</span><span class="go">File end.</span></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code">
            
          <pre class="chroma"><span class="go">Program exited.</span></pre>
          </td>
        </tr>
        
      </table>
      
      

    <p class="footer">
      by <a href="https://sunwei.xyz">孙伟</a>
      | <a href="https://github.com/sunwei/gobyexample">source</a>
      | <a href="https://github.com/sunwei/gobyexample#license">license</a>
      | Inspired by <a href="https://github.com/mmcgrana/gobyexample">gobyexample.com</a>
      | Build with LOVE 💞
    </p>

    </div>
    <script>
      var codeLines = [];
      codeLines.push('package main\u000A');codeLines.push('import (\u000A    \"bytes\"\u000A    \"fmt\"\u000A    toml \"github.com/pelletier/go-toml/v2\"\u000A    \"golang.org/x/tools/txtar\"\u000A    \"path/filepath\"\u000A    \"strings\"\u000A)\u000A');codeLines.push('var files \u003D \"-- config.toml --\\n\" +\u000A    \"theme \u003D \'mytheme\'\"\u000A');codeLines.push('type Format string\u000A');codeLines.push('const (\u000A    TOML Format \u003D \"toml\"\u000A)\u000A');codeLines.push('func main() {\u000A');codeLines.push('    data :\u003D txtar.Parse([]byte(files))\u000A    fmt.Println(\"File start:\")\u000A');codeLines.push('    var configData []byte\u000A    var format Format\u000A    m :\u003D make(map[string]any)\u000A');codeLines.push('    for _, f :\u003D range data.Files {\u000A        if \"config.toml\" \u003D\u003D f.Name {\u000A            configData \u003D bytes.TrimSuffix(\u000A                f.Data, []byte(\"\\n\"))\u000A            format \u003D FormatFromString(f.Name)\u000A        }\u000A    }\u000A');codeLines.push('    err :\u003D UnmarshalTo(configData, format, \u0026m)\u000A    if err !\u003D nil {\u000A        fmt.Println(err)\u000A    } else {\u000A        fmt.Println(m)\u000A    }\u000A');codeLines.push('    fmt.Println(\"File end.\")\u000A}\u000A');codeLines.push('func FormatFromString(formatStr string) Format {\u000A    formatStr \u003D strings.ToLower(formatStr)\u000A    if strings.Contains(formatStr, \".\") {\u000A');codeLines.push('        formatStr \u003D strings.TrimPrefix(\u000A            filepath.Ext(formatStr), \".\")\u000A    }\u000A    switch formatStr {\u000A    case \"toml\":\u000A        return TOML\u000A    }\u000A');codeLines.push('    return \"\"\u000A}\u000A');codeLines.push('func UnmarshalTo(data []byte, f Format, v any) error {\u000A    var err error\u000A');codeLines.push('    switch f {\u000A    case TOML:\u000A        err \u003D toml.Unmarshal(data, v)\u000A');codeLines.push('    default:\u000A        return fmt.Errorf(\u000A            \"unmarshal of format %q is not supported\", f)\u000A    }\u000A');codeLines.push('    if err \u003D\u003D nil {\u000A        return nil\u000A    }\u000A');codeLines.push('    return err\u000A}\u000A');codeLines.push('');codeLines.push('');
    </script>
    <script src="site.js" async></script>
  </body>
</html>
