<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>深入理解Hugo: Fsm</title>
    <link rel=stylesheet href="site.css">
  </head>
  <script>
      onkeydown = (e) => {
          
          if (e.key == "ArrowLeft") {
              window.location.href = 'markdown-parser';
          }
          
          
          if (e.key == "ArrowRight") {
              window.location.href = 'action-lexer';
          }
          
      }
  </script>
  <body>
    <div class="example" id="fsm">
      <h2><a href="./">深入理解Hugo</a>: Fsm</h2>
      
      <table>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            <a href="https://go.dev/play/p/hu3_ZxvyBq6"><img title="Run code" src="play.png" class="run" /></a><img title="Copy code" src="clipboard.png" class="copy" />
          <pre class="chroma"><span class="kn">package</span> <span class="nx">main</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;errors&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/sunwei/gobyexample/modules/fsm&#34;</span>
<span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>initial fsm with init state and data</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>add state with handler</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">f</span> <span class="o">:=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">firstState</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">{</span>
        <span class="nx">err</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="nx">raw</span><span class="p">:</span> <span class="s">&#34;first&#34;</span><span class="p">,</span>
    <span class="p">})</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>error occurs</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">f</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">firstState</span><span class="p">,</span>
        <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="p">(</span><span class="nx">fsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Action</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nf">Data</span><span class="p">().</span><span class="nf">Raw</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">secondState</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">{</span>
                <span class="nx">err</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                <span class="nx">raw</span><span class="p">:</span> <span class="s">&#34;second&#34;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="nx">f</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">secondState</span><span class="p">,</span>
        <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="p">(</span><span class="nx">fsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Action</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nf">Data</span><span class="p">().</span><span class="nf">Raw</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">lastState</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">{</span>
                <span class="nx">err</span><span class="p">:</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;something wrong&#34;</span><span class="p">),</span>
                <span class="nx">raw</span><span class="p">:</span> <span class="s">&#34;last&#34;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>if there is no error
quite with eof state</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="nx">f</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">lastState</span><span class="p">,</span>
        <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="p">(</span><span class="nx">fsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">fsm</span><span class="p">.</span><span class="nx">Data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">event</span><span class="p">.</span><span class="nf">Data</span><span class="p">().</span><span class="nf">Error</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">errorState</span><span class="p">,</span> <span class="kc">nil</span>
            <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">            <span class="k">return</span> <span class="nx">eofState</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">{</span>
                <span class="nx">err</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                <span class="nx">raw</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>send message to notify fsm start the processing</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">    <span class="k">for</span> <span class="p">{</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>quit with error</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">        <span class="nx">e</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;continue&#34;</span><span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>quite for eof state</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">        <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;break because of error&#34;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma">        <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span> <span class="o">==</span> <span class="nx">eofState</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;eof&#34;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">firstState</span>  <span class="p">=</span> <span class="s">&#34;first&#34;</span>
    <span class="nx">secondState</span> <span class="p">=</span> <span class="s">&#34;second&#34;</span>
    <span class="nx">lastState</span>   <span class="p">=</span> <span class="s">&#34;last&#34;</span>
    <span class="nx">errorState</span>  <span class="p">=</span> <span class="s">&#34;error&#34;</span>
    <span class="nx">eofState</span>    <span class="p">=</span> <span class="s">&#34;eof&#34;</span>
<span class="p">)</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><span class="kd">type</span> <span class="nx">data</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="kt">error</span>
    <span class="nx">raw</span> <span class="nx">any</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code">
            
          <pre class="chroma"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">data</span><span class="p">)</span> <span class="nf">Error</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">err</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">data</span><span class="p">)</span> <span class="nf">Raw</span><span class="p">()</span> <span class="nx">any</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">raw</span>
<span class="p">}</span>
</pre>
          </td>
        </tr>
        
      </table>
      
      <table>
        
        <tr>
          <td class="docs">
            <p>FSM example</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma">
<span class="go">first
</span><span class="go">second
</span><span class="go">break because of error</span></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code">
            
          <pre class="chroma"><span class="go">Program exited.</span></pre>
          </td>
        </tr>
        
      </table>
      
      
      <p class="next">
        Next example: <a href="action-lexer">Action Lexer</a>.
      </p>
      

    <p class="footer">
      by <a href="https://sunwei.xyz">孙伟</a>
      | <a href="https://github.com/sunwei/gobyexample">source</a>
      | <a href="https://github.com/sunwei/gobyexample#license">license</a>
      | Inspired by <a href="https://github.com/mmcgrana/gobyexample">gobyexample.com</a>
      | Build with LOVE 💞
    </p>

    </div>
    <script>
      var codeLines = [];
      codeLines.push('package main\u000A');codeLines.push('import (\u000A    \"errors\"\u000A    \"fmt\"\u000A    \"github.com/sunwei/gobyexample/modules/fsm\"\u000A)\u000A');codeLines.push('func main() {\u000A');codeLines.push('    f :\u003D fsm.New(firstState, \u0026data{\u000A        err: nil,\u000A        raw: \"first\",\u000A    })\u000A');codeLines.push('    f.Add(firstState,\u000A        func(event fsm.Event) (fsm.State, fsm.Data) {\u000A            if event.Type() \u003D\u003D fsm.Action {\u000A                fmt.Println(event.Data().Raw())\u000A            }\u000A            return secondState, \u0026data{\u000A                err: nil,\u000A                raw: \"second\",\u000A            }\u000A        })\u000A    f.Add(secondState,\u000A        func(event fsm.Event) (fsm.State, fsm.Data) {\u000A            if event.Type() \u003D\u003D fsm.Action {\u000A                fmt.Println(event.Data().Raw())\u000A            }\u000A            return lastState, \u0026data{\u000A                err: errors.New(\"something wrong\"),\u000A                raw: \"last\",\u000A            }\u000A        })\u000A');codeLines.push('    f.Add(lastState,\u000A        func(event fsm.Event) (fsm.State, fsm.Data) {\u000A            if e :\u003D event.Data().Error(); e !\u003D nil {\u000A                fmt.Println(e)\u000A                return errorState, nil\u000A            }\u000A');codeLines.push('            return eofState, \u0026data{\u000A                err: nil,\u000A                raw: \"\",\u000A            }\u000A        })\u000A');codeLines.push('    for {\u000A');codeLines.push('        e :\u003D f.Process(\"continue\")\u000A');codeLines.push('        if e !\u003D nil {\u000A            fmt.Println(\"break because of error\")\u000A            break\u000A        }\u000A');codeLines.push('        if f.State() \u003D\u003D eofState {\u000A            fmt.Println(\"eof\")\u000A            break\u000A        }\u000A    }\u000A}\u000A');codeLines.push('const (\u000A    firstState  \u003D \"first\"\u000A    secondState \u003D \"second\"\u000A    lastState   \u003D \"last\"\u000A    errorState  \u003D \"error\"\u000A    eofState    \u003D \"eof\"\u000A)\u000A');codeLines.push('type data struct {\u000A    err error\u000A    raw any\u000A}\u000A');codeLines.push('func (d *data) Error() error {\u000A    return d.err\u000A}\u000Afunc (d *data) Raw() any {\u000A    return d.raw\u000A}\u000A');codeLines.push('');codeLines.push('');
    </script>
    <script src="site.js" async></script>
  </body>
</html>
